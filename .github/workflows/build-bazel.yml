name: "Build Bazel"

on:
  workflow_call:
    inputs:
      config:
        description: "Bazel Config"
        required: true
        type: string
      compilation-mode:
        description: "Bazel Compilation-Mode"
        required: true
        type: string
      run-tests:
        description: "Run Tests"
        required: false
        type: boolean
        default: true

jobs:
  build-test:
    if: ${{ inputs.run-tests }}
    needs: build
    runs-on: ubuntu-latest
    permissions: read-all
    steps:
      - uses: actions/checkout@v4.1.1
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: true
          swap-storage: true
      - uses: bazel-contrib/setup-bazel@0.15.0
        with:
          # Avoid downloading Bazel every time.
          bazelisk-cache: true
          # Store build cache per workflow.
          disk-cache: false
          # Share repository cache between workflows.
          repository-cache: true
      - name: Test
        run: bazelisk test --test_output=errors //modules/... --config remote-cache --config ${{ inputs.config }} -c ${{ inputs.compilation-mode }}
